/**
 * Created by liujun on 2016/8/25.
 */
'use strict';

var async = require('async');
var service = require('mcp_service');
var calculateService = service.calculateService;
var creditorCalculateService = service.creditorCalculateService;
var creditorUtilService = service.creditorUtilService;

var cons = require('mcp_constants');
var calCons = cons.calculateCons;

var esut = require('easy_util');
var dateUtil = esut.dateUtil;

var util = require('mcp_util');
var creditorDateUtil = util.creditorDateUtil;

var dc = require('mcp_db').dc;


var CreditorAyfxEngine = function () {
    var self = this;
};

/**
 * 按月付息的本金和利息操作
 * 债权购买
 */
CreditorAyfxEngine.prototype.ayfxCreditor = function (id,money,creditorLoanObj,i,j,loanObj,loanRepayObj,curRepayDay,curDay,preRepayDay,data,investObj,surMoney, cb) {
    //业务处理
    var k = i;
    var h = i;
    //业务参数处理
    var money2 = 0.00;
    var interest2 = 0.00;
    var tempMoney = 0.00;
    var tempInterest = 0.00;
    var creditorData = data;
    //受让金额的总利息
    var totalInterest = creditorDateUtil.twoPrecise((money/(loanObj.money))*creditorData);
    console.log("受让金额的总利息为：" + totalInterest);
    async.whilst(
        function () {
            return j - i >= 0;
        },
        function (whileCb) {

            var creditor_invest_repayTab = dc.main.get('creditor_invest_repay');
            var invest_repayTab = dc.main.get('invest_repay');
            var investTab = dc.main.get('invest');

            var _index = i;
            var period = _index;
            var investRepayId = investObj.id + '_' + period;
            //var tran_money = 4.00;
            //var tran_interest = 1.00;

            //当月应还本金、利息(自己计算)
            /*var repay = calculateService.deMonthSumCal(loanObj.rate,loanObj.money,loanObj.deadline);
             var interest = calculateService.deMonthInterestCal(loanObj.rate, loanObj.money,repay,i);*/

            creditorUtilService.getMonInterCur(loanObj.id, i, j, function (err, data) {
                if (err) {
                    console.log(err);
                }else {
                    var moneyCur = data.money;
                    var interestCur = data.interest;
                    console.log("当月应还本金---------：" + i + "-----" + moneyCur);
                    console.log("当月应还利息---------：" + i + "-----" + interestCur);
                    //参数值
                    var total_price = creditorLoanObj.total_price;
                    //当期应还本金
                    money2 = creditorCalculateService.acceptmoney(money,total_price,moneyCur,surMoney);

                    //受让人本金利息
                    if(period == k) {
                        interest2 = creditorCalculateService.acceptinterestCur(curRepayDay,curDay,preRepayDay,money,total_price,interestCur,surMoney);

                        console.log("受让人本金---------：" + i + "-----" + money2);
                        console.log("受让人利息---------：" + i + "-----" + interest2);

                        tempMoney += money2;
                        tempInterest += interest2;

                    } else if (period != loanObj.deadline){

                        interest2 = creditorCalculateService.acceptinterest(money,total_price,interestCur,surMoney);

                        console.log("-----------受让人本金---------：" + i + "-----" + money2);
                        console.log("-----------受让人利息---------：" + i + "-----" + interest2);

                        tempMoney += money2;
                        tempInterest += interest2;

                    }
                    if (period == loanObj.deadline && period != h) {

                        money2 = money - tempMoney;
                        interest2 = totalInterest - tempInterest;

                        console.log("-----------受让人本金---------：" + i + "-----" + money2);
                        console.log("-----------受让人利息---------：" + i + "-----" + interest2);
                    }

                    var cond = {};
                    cond.id = id + '_' + period;
                    cond.money = money2;
                    cond.interest = interest2;
                    cond.creditor_invest_id = id;
                    cond.period = period;
                    cond.all_period = loanObj.deadline;
                    cond.create_time = dateUtil.getCurTime();
                    cond.status = 0;

                    creditor_invest_repayTab.save(cond, [], function (err) {
                        if(err) {
                            console.log(err);
                        } else {
                            investTab.findOne({id: creditorLoanObj.invest_id}, {}, [], function (err, investObj) {
                                if (investObj != null) {
                                    invest_repayTab.update({id: investRepayId}, {$inc: { tran_money : money2!=0 ? money2 : "+" + 0, tran_interest : interest2 }}, [], function (err) {
                                        if (err) {
                                            console.log(err);
                                        }else {
                                            i++;
                                            whileCb();
                                        }
                                    });
                                }else {
                                    creditor_invest_repayTab.update({id: investRepayId}, {$inc: { tran_money : money2!=0 ? money2 : "+" + 0, tran_interest : interest2 }}, [], function (err) {
                                        if (err) {
                                            console.log(err);
                                        }else {
                                            i++;
                                            whileCb();
                                        }
                                    });
                                }
                            });
                        }

                    });
                }
            });

        },
        function (err) {
            if(err) {
                //处理
                console.log(err);
            } else {
                cb(err);
            }
        }
    );
};

var creditorAyfxEngine = new CreditorAyfxEngine();
module.exports = creditorAyfxEngine;
