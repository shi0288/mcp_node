/**
 * Created by shiqm on 16-3-24.
 */
'use strict';

var dc = require('mcp_db').dc;

var esul = require('easy_util');
var digestUtil = esul.digestUtil;

var util = require('mcp_util');
var objectUtil = util.objectUtil;

var async = require('async');

var UserService = function () {
};

UserService.prototype.getUserList = function (fields, skip, limit, cb) {
    console.log("-----------------"+fields);
    var conn = dc.main.getConn();
    var sql = "SELECT a.status,a.id,a.username,a.realname,a.sex,a.mobile,b.username referrerUsername,b.realname referrerRealname, b.mobile referrerMobileNumber,b.card,a.createTime,case (select COUNT(*) from invest where user_id=a.id and status='complete') when '0' then '未投资' else '已投资' end  as invset_status from user a left join user b  on a.referrer=b.id limit "+skip+","+limit;
   if (fields == null || fields == undefined){
       console.log(sql);
       conn.execute(sql, [], function (err, data) {
           cb(err, data);
       })
        return;
    }else{
    console.log("------------------------"+fields.indexOf("role"));
       var fields2  = JSON.parse(fields);
       if(fields.indexOf("role")>=0 && fields2['role'] != ''){
           sql = "SELECT " +
           "	a.status," +
           "    a.id, " +
           "	a.username, " +
           "	a.realname, " +
           "	a.sex, " +
           "	a.mobile, " +
           "	b.username referrerUsername, " +
           "	b.realname referrerRealname, " +
           "	b.mobile referrerMobileNumber, " +
           "	b.card, " +
           "	a.createTime, " +
           "	CASE ( " +
           "		SELECT " +
           "			COUNT(*) " +
           "		FROM " +
           "			invest " +
           "		WHERE " +
           "			user_id = a.id " +
           "		AND STATUS = 'complete' " +
           "	) " +
           "WHEN '0' THEN " +
           "	'未投资' " +
           "ELSE " +
           "	'已投资' " +
           "END AS invset_status " +
           "FROM " +
           "	USER a " +
           "LEFT JOIN USER b ON a.referrer = b.id " +
           "LEFT JOIN user_role c ON a.id = c.user_id " +
           "WHERE 1=1";

           fields = JSON.parse(fields);
           for(var i in fields){
               if(fields[i]!="") {
                   if (i == "id" && fields[i] !== '') {
                       sql += " and a.id = '" + fields[i] + "'";
                   } else if (i == "username") {
                       sql += " and a.username = '" + fields[i] + "'";
                   } else if (i == "startCreateTime") {
                       sql += " and a.createTime >= '" + new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss") + "'";
                   } else if (i == "endCreateTime") {
                       sql += " and a.createTime <= '" + new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss") + "'";
                   } else if (i == "referrerUsername") {
                       sql += " and a.referrer = '" + fields[i] + "'";
                   } else if (i == "role") {
                       sql += " and c.role_id = '" + fields[i] + "'";
                   }
               }
           }

           sql += " limit "+skip+","+limit;
           console.log("---------------------------------"+sql);
           conn.execute(sql, [], function (err, data) {
               cb(err, data);
           })
       }else{

           sql ="SELECT " +
           "	a.status," +
           "    a.id, " +
           "	a.username, " +
           "	a.realname, " +
           "	a.sex, " +
           "	a.mobile, " +
           "	b.username referrerUsername, " +
           "	b.realname referrerRealname, " +
           "	b.mobile referrerMobileNumber, " +
           "	b.card, " +
           "	a.createTime, " +
           "	CASE ( " +
           "		SELECT " +
           "			COUNT(*) " +
           "		FROM " +
           "			invest " +
           "		WHERE " +
           "			user_id = a.id " +
           "		AND STATUS = 'complete' " +
           "	) " +
           "WHEN '0' THEN " +
           "	'未投资' " +
           "ELSE " +
           "	'已投资' " +
           "END AS invset_status " +
           "FROM " +
           "	USER a " +
           "LEFT JOIN USER b ON a.referrer = b.id " +
           "WHERE 1=1";
           fields = JSON.parse(fields);
           console.log(fields);
           for (var i in fields) {
               if(fields[i]!=""){
                   if(i=="id"){
                       sql += " and a.id = '"+fields[i]+"'";
                   }else if(i=="username"){
                       sql += " and a.username = '"+fields[i]+"'";
                   }else if(i=="startCreateTime"){
                       sql += " and a.createTime >= '"+new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss")+"'";
                   }else if(i=="endCreateTime"){
                       sql += " and a.createTime <= '"+new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss")+"'";
                   }else if(i=="referrerUsername"){
                       sql += " and a.referrer = '"+fields[i]+"'";
                   }
               }
           }
           sql += " limit "+skip+","+limit;
           console.log("---------------------------------"+sql);
           conn.execute(sql, [], function (err, data) {
               cb(err, data);
           })
       }
   }

};

UserService.prototype.getUserCount = function (fields, skip, limit, cb) {
    console.log("-----------------"+fields);
    var conn = dc.main.getConn();
    var sql = "select count(1) count from (SELECT a.status,a.id,a.username,a.realname,a.sex,a.mobile,b.username referrerUsername,b.realname referrerRealname, b.mobile referrerMobileNumber,b.card,a.createTime,case (select COUNT(*) from invest where user_id=a.id and status='complete') when '0' then '未投资' else '已投资' end  as invset_status from user a left join user b  on a.referrer=b.id) a";
    if (fields == null || fields == undefined){
        console.log(sql);
        conn.execute(sql, [], function (err, data) {
            cb(err, data);
        })
        return;
    }else{
        console.log("------------------------"+fields.indexOf("role"));
        var fields2  = JSON.parse(fields);
        if(fields.indexOf("role")>=0 && fields2['role'] != ''){
            sql = "select count(1) count from (SELECT " +
            "	a.status," +
            "   a.id, " +
            "	a.username, " +
            "	a.realname, " +
            "	a.sex, " +
            "	a.mobile, " +
            "	b.username referrerUsername, " +
            "	b.realname referrerRealname, " +
            "	b.mobile referrerMobileNumber, " +
            "	b.card, " +
            "	a.createTime, " +
            "	CASE ( " +
            "		SELECT " +
            "			COUNT(*) " +
            "		FROM " +
            "			invest " +
            "		WHERE " +
            "			user_id = a.id " +
            "		AND STATUS = 'complete' " +
            "	) " +
            "WHEN '0' THEN " +
            "	'未投资' " +
            "ELSE " +
            "	'已投资' " +
            "END AS invset_status " +
            "FROM " +
            "	USER a " +
            "LEFT JOIN USER b ON a.referrer = b.id " +
            "LEFT JOIN user_role c ON a.id = c.user_id " +
            "WHERE 1=1";

            fields = JSON.parse(fields);
            for(var i in fields){
                if(fields[i]!="") {
                    if (i == "id" && fields[i] !== '') {
                        sql += " and a.id = '" + fields[i] + "'";
                    } else if (i == "username") {
                        sql += " and a.username = '" + fields[i] + "'";
                    } else if (i == "startCreateTime") {
                        sql += " and a.createTime >= '" + new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss") + "'";
                    } else if (i == "endCreateTime") {
                        sql += " and a.createTime <= '" + new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss") + "'";
                    } else if (i == "referrerUsername") {
                        sql += " and a.referrer = '" + fields[i] + "'";
                    } else if (i == "role") {
                        sql += " and c.role_id = '" + fields[i] + "'";
                    }
                }
            }
            sql+=") a";
            console.log("---------------------------------"+sql);
            conn.execute(sql, [], function (err, data) {
                cb(err, data);
            })
        }else{

            sql ="select count(1) count from (SELECT " +
            "	a.status," +
            "   a.id, " +
            "	a.username, " +
            "	a.realname, " +
            "	a.sex, " +
            "	a.mobile, " +
            "	b.username referrerUsername, " +
            "	b.realname referrerRealname, " +
            "	b.mobile referrerMobileNumber, " +
            "	b.card, " +
            "	a.createTime, " +
            "	CASE ( " +
            "		SELECT " +
            "			COUNT(*) " +
            "		FROM " +
            "			invest " +
            "		WHERE " +
            "			user_id = a.id " +
            "		AND STATUS = 'complete' " +
            "	) " +
            "WHEN '0' THEN " +
            "	'未投资' " +
            "ELSE " +
            "	'已投资' " +
            "END AS invset_status " +
            "FROM " +
            "	USER a " +
            "LEFT JOIN USER b ON a.referrer = b.id " +
            "WHERE 1=1";
            fields = JSON.parse(fields);
            console.log(fields);
            for (var i in fields) {
                if(fields[i]!=""){
                    if(i=="id"){
                        sql += " and a.id = '"+fields[i]+"'";
                    }else if(i=="username"){
                        sql += " and a.username = '"+fields[i]+"'";
                    }else if(i=="startCreateTime"){
                        sql += " and a.createTime >= '"+new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss")+"'";
                    }else if(i=="endCreateTime"){
                        sql += " and a.createTime <= '"+new Date(fields[i]).Format("yyyy-MM-dd HH:mm:ss")+"'";
                    }else if(i=="referrerUsername"){
                        sql += " and a.referrer = '"+fields[i]+"'";
                    }
                }
            }
            sql+=") a";
            console.log("---------------------------------"+sql);
            conn.execute(sql, [], function (err, data) {
                cb(err, data);
            })
        }
    }

};

Date.prototype.Format = function (fmt) { //author: meizz
    var o = {
        "M+": this.getMonth() + 1, //月份
        "d+": this.getDate(), //日
        "H+": this.getHours(), //小时
        "m+": this.getMinutes(), //分
        "s+": this.getSeconds(), //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds() //毫秒
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    return fmt;
}
module.exports = new UserService();