/**
 * Created by shiqm on 16-3-24.
 */
'use strict';

var dc = require('mcp_db').dc;

var esul = require('easy_util');
var digestUtil = esul.digestUtil;

var moment = require("moment");

var async = require('async');

var UserService = function () {
};

UserService.prototype.getUserList = function (fields, skip, limit, cb) {
    var conn = dc.main.getConn();
    var condition = "";
    if (fields != undefined && fields != null) {
        for (var key in fields) {
            condition += " and " + key + "='" + fields[key] + "'";
        }
    }
    if (skip == undefined) {
        skip = 0;
    }
    if (limit == undefined || limit > 40) {
        limit = 40;
    }
    var limitStr= " limit " + skip + "," + limit;
    var fields="a.*,b.realname as referrerName,b.mobile as referrerMobile," +
    " case (select count(*) from invest inv where inv.user_id=a.id and inv.status!=1100 ) when 0 then 0 else 1 END as invStatus ";

    var sql = "select "+fields+" from user a LEFT JOIN user b on a.referrer=b.username  " +
        " where 1=1  " + condition +
        " order by a.createTime DESC " +limitStr;


    conn.execute(sql, [], function (err, data) {
        for (var key in data) {
            data[key]['createTime'] = moment(data[key]['createTime']).format("YYYY-MM-DD HH:mm:ss");
        }

        var countSql = "select count(a.id) as num from user a LEFT JOIN user b on a.referrer=b.username  " +
            " where 1=1  " + condition +
            " order by a.createTime DESC ";
        conn.execute(countSql, [], function (err, numData) {
            console.log("==============");
            console.log(numData);
            console.log("==============");
            cb(err, data, numData[0].num);
        })
    })
};


module.exports = new UserService();